version: "3.9"

services:
  vernemq:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE:-latest}
        - VCS_REF=${VCS_REF:-local}
    image: vernemq:latest
    container_name: vernemq-prod
    restart: unless-stopped
    
    # Network configuration
    ports:
      - "1883:1883"   # MQTT TCP
      - "8883:8883"   # MQTT SSL/TLS
      - "8080:8080"   # WebSocket
      - "8083:8083"   # WebSocket SSL/TLS
      - "8888:8888"   # Management HTTP
      - "8889:8889"   # Management HTTPS
    
    # Environment variables
    environment:
      - VERNEMQ_NODENAME=VerneMQ@vernemq
      - VERNEMQ_DISTRIBUTED_COOKIE=${DISTRIBUTED_COOKIE:-change_this_secret_cookie}
      - VERNEMQ_MAX_CONNECTIONS=50000
      - VERNEMQ_ALLOW_ANONYMOUS=off
      - VERNEMQ_LOG_CONSOLE=file
      - VERNEMQ_LOG_ERROR=file
      - VERNEMQ_MAX_MESSAGE_SIZE=1048576
      - VERNEMQ_MAX_INFLIGHT_MESSAGES=20
      - VERNEMQ_MAX_MESSAGE_QUEUE_SIZE=1000
      - VERNEMQ_PERSISTENT_CLIENT_EXPIRATION=1d
      - VERNEMQ_METRICS_ENABLED=on
      - VERNEMQ_VMQ_MEMORY_HIGH_WATERMARK=0.75
      - VERNEMQ_ULIMIT_OPEN_FILES=65536
      # Optional: Enable plugins for enhanced functionality
      # - VERNEMQ_PLUGIN_VMQ_DIVERSITY=on
      # - VERNEMQ_VMQ_DIVERSITY_AUTH_BACKEND=vmq_plugin
      # TLS/SSL Configuration (uncomment if using SSL)
      # - VERNEMQ_LISTENER_SSL_DEFAULT=on
      # - VERNEMQ_LISTENER_SSL_DEFAULT_PORT=8883
      # - VERNEMQ_LISTENER_SSL_DEFAULT_PROTOCOLS=tlsv1.2,tlsv1.3
      # - VERNEMQ_LISTENER_SSL_DEFAULT_CACERTFILE=/opt/vernemq/etc/ssl/cacert.pem
      # - VERNEMQ_LISTENER_SSL_DEFAULT_CERTFILE=/opt/vernemq/etc/ssl/cert.pem
      # - VERNEMQ_LISTENER_SSL_DEFAULT_KEYFILE=/opt/vernemq/etc/ssl/key.pem
    
    # Resource limits
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    
    # Volume mounts for persistent data and configuration
    volumes:
      - vernemq_data:/opt/vernemq/data
      - vernemq_log:/opt/vernemq/log
      - vernemq_etc:/opt/vernemq/etc
      # Mount custom configuration file (optional)
      # - ./vernemq-production.conf:/opt/vernemq/etc/vernemq.conf:ro
      # Mount TLS certificates (if using SSL)
      # - ./ssl:/opt/vernemq/etc/ssl:ro
    
    # Health check
    healthcheck:
      test: ["CMD", "/opt/vernemq/bin/vmq-admin", "cluster", "status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # User configuration (runs as non-root)
    user: "vernemq:vernemq"
    
    # Network
    networks:
      - vernemq_network
    
    # Labels for monitoring and organization
    labels:
      - "com.vernemq.version=latest"
      - "com.vernemq.role=broker"
      - "com.vernemq.environment=production"
      - "com.vernemq.single-container=true"

# Named volumes for persistent data
volumes:
  vernemq_data:
    driver: local
  vernemq_log:
    driver: local
  vernemq_etc:
    driver: local

# Custom network
networks:
  vernemq_network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16