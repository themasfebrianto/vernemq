groups:
  - name: vernemq_alerts
    rules:
      # VerneMQ Broker Alerts
      - alert: VerneMQDown
        expr: up{job="vernemq"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "VerneMQ broker is down"
          description: "VerneMQ broker has been unreachable for more than 1 minute."

      - alert: VerneMQHighConnectionRate
        expr: rate(vernemq_mqtt_connect_received[5m]) > 100
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High connection rate detected"
          description: "VerneMQ is receiving more than 100 new connections per second."

      - alert: VerneMQHighDisconnectRate
        expr: rate(vernemq_mqtt_disconnect_received[5m]) > 50
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High disconnect rate detected"
          description: "VerneMQ is seeing more than 50 disconnects per second, which may indicate network issues."

      - alert: VerneMQHighPublishRate
        expr: rate(vernemq_mqtt_publish_received[5m]) > 10000
        for: 5m
        labels:
          severity: info
        annotations:
          summary: "High message publish rate"
          description: "VerneMQ is processing more than 10,000 messages per second."

  - name: webhook_alerts
    rules:
      # Webhook Auth Service Alerts
      - alert: WebhookAuthDown
        expr: up{job="webhook-auth"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Webhook Auth service is down"
          description: "The webhook authentication service has been unreachable for more than 1 minute."

      - alert: WebhookHighErrorRate
        expr: sum(rate(http_requests_received_total{code=~"5.."}[5m])) / sum(rate(http_requests_received_total[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate in webhook service"
          description: "More than 5% of requests are resulting in 5xx errors."

      - alert: WebhookHighLatency
        expr: histogram_quantile(0.95, sum(rate(http_request_duration_seconds_bucket[5m])) by (le)) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High webhook latency"
          description: "95th percentile latency is above 1 second."

  - name: infrastructure_alerts
    rules:
      # Prometheus Self-Monitoring
      - alert: PrometheusTargetMissing
        expr: up == 0
        for: 2m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus target missing"
          description: "A Prometheus target {{ $labels.instance }} has disappeared."

      - alert: PrometheusHighMemoryUsage
        expr: process_resident_memory_bytes{job="prometheus"} > 800000000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Prometheus high memory usage"
          description: "Prometheus is using more than 800MB of memory."
