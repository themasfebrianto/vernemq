version: "3.9"

# Cross-platform Docker Compose configuration for VerneMQ testing
# Supports both Windows and Linux hosts

services:
  # VerneMQ Test Instance
  vernemq:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - BUILD_DATE=${BUILD_DATE:-test}
        - VCS_REF=${VCS_REF:-test}
    image: vernemq:test
    container_name: vernemq-test
    restart: unless-stopped
    
    ports:
      - "1883:1883"   # MQTT TCP
      - "1884:1884"   # MQTT TCP Test Port
      - "8883:8883"   # MQTT SSL/TLS
      - "8080:8080"   # WebSocket
      - "8083:8083"   # WebSocket SSL/TLS
      - "8888:8888"   # Management HTTP
      - "8889:8889"   # Management HTTPS
    
    environment:
      - VERNEMQ_NODENAME=VerneMQ@test
      - VERNEMQ_DISTRIBUTED_COOKIE=test_cookie_change_me_in_production
      - VERNEMQ_MAX_CONNECTIONS=1000
      - VERNEMQ_ALLOW_ANONYMOUS=on
      - VERNEMQ_LOG_CONSOLE=file
      - VERNEMQ_LOG_ERROR=file
      - VERNEMQ_MAX_MESSAGE_SIZE=1048576
      - VERNEMQ_MAX_INFLIGHT_MESSAGES=20
      - VERNEMQ_MAX_MESSAGE_QUEUE_SIZE=1000
      - VERNEMQ_PERSISTENT_CLIENT_EXPIRATION=1d
      - VERNEMQ_METRICS_ENABLED=on
      - VERNEMQ_VMQ_MEMORY_HIGH_WATERMARK=0.75
      - VERNEMQ_ULIMIT_OPEN_FILES=65536
      # Test-specific configurations
      - VERNEMQ_LISTENER_TCP_TEST=0.0.0.0:1884
      - VERNEMQ_WEBSOCKET_ENABLED=on
      - VERNEMQ_HTTP_PUB_ENABLED=on
      # Cross-platform compatibility
      - PLATFORM_DETECTED=${PLATFORM_DETECTED:-unknown}
    
    volumes:
      - vernemq_test_data:/opt/vernemq/data
      - vernemq_test_log:/opt/vernemq/log
      - vernemq_test_etc:/opt/vernemq/etc
      - ./test-automation/config:/opt/vernemq/etc/conf.d:ro
      - ./test-automation/ssl:/opt/vernemq/etc/ssl:ro
      # Cross-platform volume mappings
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Linux only, ignored on Windows
    
    healthcheck:
      test: ["CMD", "/opt/vernemq/bin/vmq-admin", "cluster", "status"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    networks:
      - vernemq_test_network
    
    depends_on:
      - redis
      - postgres
      - mongodb
      - memcached

  # Redis for session storage and caching
  redis:
    image: redis:7-alpine
    container_name: vernemq-redis-test
    restart: unless-stopped
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    ports:
      - "6379:6379"
    volumes:
      - redis_test_data:/data
    networks:
      - vernemq_test_network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # PostgreSQL for user authentication and metadata
  postgres:
    image: postgres:15-alpine
    container_name: vernemq-postgres-test
    restart: unless-stopped
    environment:
      - POSTGRES_DB=vernemq_test
      - POSTGRES_USER=vmq_test_user
      - POSTGRES_PASSWORD=vmq_test_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_test_data:/var/lib/postgresql/data
      - ./test-automation/sql/init-test.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - vernemq_test_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U vmq_test_user -d vernemq_test"]
      interval: 5s
      timeout: 3s
      retries: 5

  # MongoDB for plugin data storage
  mongodb:
    image: mongo:5.0
    container_name: vernemq-mongodb-test
    restart: unless-stopped
    environment:
      - MONGO_INITDB_ROOT_USERNAME=vmq_test_user
      - MONGO_INITDB_ROOT_PASSWORD=vmq_test_password
      - MONGO_INITDB_DATABASE=vernemq_test
    ports:
      - "27017:27017"
    volumes:
      - mongodb_test_data:/data/db
    networks:
      - vernemq_test_network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 5s
      timeout: 3s
      retries: 5

  # Memcached for plugin caching
  memcached:
    image: memcached:alpine
    container_name: vernemq-memcached-test
    restart: unless-stopped
    command: memcached -m 64 -p 11211
    ports:
      - "11211:11211"
    networks:
      - vernemq_test_network
    healthcheck:
      test: ["CMD", "sh", "-c", "echo stats | nc localhost 11211"]
      interval: 5s
      timeout: 3s
      retries: 5

  # MySQL for diversity plugin testing
  mysql:
    image: mysql:8.0
    container_name: vernemq-mysql-test
    restart: unless-stopped
    environment:
      - MYSQL_ROOT_PASSWORD=vmq_test_password
      - MYSQL_DATABASE=vernemq_test
      - MYSQL_USER=vmq_test_user
      - MYSQL_PASSWORD=vmq_test_password
    ports:
      - "3306:3306"
    volumes:
      - mysql_test_data:/var/lib/mysql
      - ./test-automation/sql/init-mysql-test.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - vernemq_test_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 5s
      timeout: 3s
      retries: 5

  # MQTT Test Client Container
  mqtt-test-client:
    image: eclipse-mosquitto:2.0
    container_name: vernemq-mqtt-client
    restart: unless-stopped
    volumes:
      - ./test-automation:/test-scripts:ro
      - ./logs:/test-logs
    networks:
      - vernemq_test_network
    depends_on:
      - vernemq
    command: >
      sh -c "
        apk add --no-cache bash curl jq netcat-openbsd procps &&
        echo 'MQTT Test Client Container Ready' &&
        tail -f /dev/null
      "

  # Load testing container (optional)
  load-tester:
    build:
      context: ./test-automation/tools
      dockerfile: Dockerfile.load-tester
    container_name: vernemq-load-tester
    restart: unless-stopped
    volumes:
      - ./test-automation:/app
      - ./logs:/app/logs
    networks:
      - vernemq_test_network
    depends_on:
      - vernemq
    profiles:
      - performance

  # Security testing container (optional)
  security-tester:
    build:
      context: ./test-automation/tools
      dockerfile: Dockerfile.security-tester
    container_name: vernemq-security-tester
    restart: unless-stopped
    volumes:
      - ./test-automation:/app
      - ./logs:/app/logs
    networks:
      - vernemq_test_network
    depends_on:
      - vernemq
    profiles:
      - security

  # Test runner container
  test-runner:
    build:
      context: ./test-automation/tools
      dockerfile: Dockerfile.test-runner
    container_name: vernemq-test-runner
    restart: unless-stopped
    volumes:
      - ./test-automation:/app
      - ./logs:/app/logs
      - ./test-results:/app/results
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker-in-Docker on Linux
    networks:
      - vernemq_test_network
    depends_on:
      - vernemq
      - redis
      - postgres
      - mongodb
      - mqtt-test-client
    profiles:
      - integration
      - full

  # Nginx reverse proxy for SSL termination (optional)
  nginx:
    image: nginx:alpine
    container_name: vernemq-nginx-test
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./test-automation/nginx/nginx-test.conf:/etc/nginx/nginx.conf:ro
      - ./test-automation/ssl:/etc/nginx/ssl:ro
      - nginx_test_logs:/var/log/nginx
    depends_on:
      - vernemq
    networks:
      - vernemq_test_network
    profiles:
      - full

# Named volumes for persistent test data
volumes:
  vernemq_test_data:
    driver: local
  vernemq_test_log:
    driver: local
  vernemq_test_etc:
    driver: local
  redis_test_data:
    driver: local
  postgres_test_data:
    driver: local
  mongodb_test_data:
    driver: local
  mysql_test_data:
    driver: local
  nginx_test_logs:
    driver: local

# Test network with explicit configuration for cross-platform compatibility
networks:
  vernemq_test_network:
    driver: bridge
    driver_opts:
      com.docker.network.bridge.name: vmq-test-bridge
    ipam:
      driver: default
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1