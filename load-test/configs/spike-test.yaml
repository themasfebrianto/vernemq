# Spike Test Configuration
# Tests system behavior under sudden, extreme load spikes
# Common scenario: flash sale, viral content, breaking news

target:
  base_url: http://api.example.com
  protocol: http
  host: api.example.com
  port: 8080
  path: /api
  timeout: 5s  # Shorter timeout for spike tests
  keep_alive: true
  max_connections: 1000
  max_idle_connections: 500

# Spike pattern: low -> high -> low
virtual_users: 50  # Initial baseline
duration: 120s
ramp_up: 5s

# Spike scenario: 5x spike for short duration
scenarios:
  - name: "baseline"
    type: linear
    virtual_users: 50
    duration: 20s
    ramp_up: 5s
    ramp_down: 5s

  - name: "spike"
    type: spike
    virtual_users: 500  # 10x spike
    duration: 30s
    ramp_up: 2s
    ramp_down: 2s

  - name: "recovery"
    type: linear
    virtual_users: 50
    duration: 20s
    ramp_up: 5s
    ramp_down: 5s

# Requests focused on read operations during spike
requests:
  # High-traffic endpoints
  - name: "product_detail"
    method: GET
    endpoint: /products/{id}
    weight: 5

  - name: "product_list"
    method: GET
    endpoint: /products
    weight: 3

  - name: "cart"
    method: GET
    endpoint: /cart
    weight: 2

  # Cart operations (critical during spike)
  - name: "add_to_cart"
    method: POST
    endpoint: /cart/items
    body: '{"product_id": {id}, "quantity": 1}'
    weight: 2
    think_time: 100ms
    headers:
      Content-Type: application/json

  - name: "checkout"
    method: POST
    endpoint: /orders
    body: '{"cart_id": {cart_id}, "payment": {}}'
    weight: 1
    think_time: 500ms
    headers:
      Content-Type: application/json

expected:
  status_codes:
    - 200
    - 201
    - 400  # Accept some validation errors during spike
    - 429  # Rate limiting is acceptable
  max_latency: 5000  # Allow higher latency during spike
  content_type: application/json

headers:
  User-Agent: loadtest-spike/1.0
  Accept: application/json

auth:
  type: none

distributed:
  enabled: true
  coordinator: coordinator.example.com:8080
  nodes:
    - spike-node-1.example.com:8081
    - spike-node-2.example.com:8081
    - spike-node-3.example.com:8081
    - spike-node-4.example.com:8081
  bind_addr: 0.0.0.0
  bind_port: 8081

report:
  output: ./results/spike-test
  format: json
  interval: 5s  # Frequent reporting during spike
  percentiles:
    - 50
    - 90
    - 95
    - 99
  detailed: true

# Spike test key metrics to monitor:
# 1. Time to recover from spike (should be < 30s)
# 2. Error rate during spike (should spike but recover quickly)
# 3. Latency increase (should not timeout completely)
# 4. Queue/backlog growth during spike
# 5. System recovery trajectory after spike
